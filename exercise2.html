<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercise 2</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-base-200 bg-blue-100 min-h-screen flex items-center justify-center p-4">
    <div class="p-4 bg-base-100 w-80 shadow-lg rounded-box">
        <div class="card-body">
            <h1 class="card-title text-primary mb-4">Location Selector</h1>
            <form action="https://jsonplaceholder.typicode.com/posts" method="post">
                <!-- Province Selection -->
                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text font-bold">Province</span></label>
                        <select id="province" name="province" class="select select-bordered w-full">
                            <option value="" disabled selected>Select Province</option>
                        </select>
                    </div>
                </div>
                <!------------------------------------------------------------------------------------------------------------------------------>

                <!-- District Selection -->
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold">District</span></label>
                    <select id="district" name="district" class="select select-bordered w-full" disabled>
                        <option value="" disabled selected>Select District</option>
                    </select>
                </div>
                <!------------------------------------------------------------------------------------------------------------------------------>

                <!-- Commune Selection -->
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold">Commune</span></label>
                    <select id="commune" name="commune" class="select select-bordered w-full" disabled>
                        <option value="" disabled selected>Select Commune</option>
                    </select>
                </div>
                <!------------------------------------------------------------------------------------------------------------------------------>

                <!-- Village Selection -->
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold">Village</span></label>
                    <select id="village" name="village" class="select select-bordered w-full" disabled>
                        <option value="" disabled selected>Select Village</option>
                    </select>
                </div>
                <!------------------------------------------------------------------------------------------------------------------------------>

                <!-- Submit and Reset Buttons -->
                <div class="card-actions justify-end mt-4">
                    <button type="submit" class="btn btn-primary">Submit</button>
                    <button type="reset" class="btn">Reset</button>
                </div>
                <!------------------------------------------------------------------------------------------------------------------------------>
            </form>

    <!-- Script for Selects -->
    <script>
        const API_BASE = "https://corsproxy.io/?https://cambo-gazetteer.manethpak.dev/api/v1";

        const selects = {
            province: document.getElementById('province'),
            district: document.getElementById('district'),
            commune: document.getElementById('commune'),
            village: document.getElementById('village')
        };

        // Helper to populate a select element
        function populateSelect(element, data, placeholder) {
            element.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
            data.forEach(item => {
                const name = item.name_en || item.name_km;
                const option = new Option(`${name} (${item.name_km})`, item.code);
                element.add(option);
            });
            element.disabled = false;
        }

        // Helper to reset lower-level selects
        function resetBelow(level) {
            const levels = ['province', 'district', 'commune', 'village'];
            const startIndex = levels.indexOf(level) + 1;
            for (let i = startIndex; i < levels.length; i++) {
                const el = selects[levels[i]];
                el.innerHTML = `<option value="" disabled selected>Select ${levels[i].charAt(0).toUpperCase() + levels[i].slice(1)}</option>`;
                el.disabled = true;
            }
        }

        // 1. Fetch Provinces
        async function fetchProvinces() {
            try {
                const response = await fetch(`${API_BASE}/provinces`);
                const data = await response.json();
                populateSelect(selects.province, data.data, "Select Province");
            } catch (error) {
                console.error("Error fetching provinces:", error);
            }
        }

        // 2. Fetch Districts when Province changes
        selects.province.addEventListener('change', async (e) => {
            resetBelow('province');
            try {
                const response = await fetch(`${API_BASE}/districts?province=${e.target.value}`);
                const data = await response.json();
                populateSelect(selects.district, data.data, "Select District");
            } catch (error) {
                console.error("Error fetching districts:", error);
            }
        });

        // 3. Fetch Communes when District changes
        selects.district.addEventListener('change', async (e) => {
            resetBelow('district');
            try {
                const response = await fetch(`${API_BASE}/communes?district=${e.target.value}`);
                const data = await response.json();
                populateSelect(selects.commune, data.data, "Select Commune");
            } catch (error) {
                console.error("Error fetching communes:", error);
            }
        });

        // 4. Fetch Villages when Commune changes
        selects.commune.addEventListener('change', async (e) => {
            resetBelow('commune');
            try {
                const response = await fetch(`${API_BASE}/villages?commune=${e.target.value}`);
                const data = await response.json();
                populateSelect(selects.village, data.data, "Select Village");
            } catch (error) {
                console.error("Error fetching villages:", error);
            }
        });

        fetchProvinces();
    </script>
    <!------------------------------------------------------------------------------------------------------------------------------>
        </div>
    </div>
</body>
</html>